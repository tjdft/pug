FROM tjdft/vue-ssr:latest

ARG TV_MODE
ARG TV_TRANSITION_INTERVAL
ARG OPENSHIFT_URL
ARG OPENSHIFT_TOKEN
ARG OPENSHIFT_REFRESH_INTERVAL
ARG SENTRY_URL
ARG SENTRY_TOKEN
ARG SENTRY_REFRESH_INTERVAL
ARG SONAR_URL
ARG SONAR_TOKEN
ARG SONAR_REFRESH_INTERVAL

ENV TV_MODE=$TV_MODE
ENV TV_TRANSITION_INTERVAL=$TV_TRANSITION_INTERVAL
ENV OPENSHIFT_URL=$OPENSHIFT_URL
ENV OPENSHIFT_TOKEN=$OPENSHIFT_TOKEN
ENV OPENSHIFT_REFRESH_INTERVAL=$OPENSHIFT_REFRESH_INTERVAL
ENV SENTRY_URL=$SENTRY_URL
ENV SENTRY_TOKEN=$SENTRY_TOKEN
ENV SENTRY_REFRESH_INTERVAL=$SENTRY_REFRESH_INTERVAL
ENV SONAR_URL=$SONAR_URL
ENV SONAR_TOKEN=$SONAR_TOKEN
ENV SONAR_REFRESH_INTERVAL=$SONAR_REFRESH_INTERVAL

ENV HOST 0.0.0.0

# Copy critical files (cached docker layers)
COPY package.json /var/www/web/
COPY yarn.lock /var/www/web/
COPY .env.example /var/www/web

# Create .env file from example
RUN mv .env.example .env

# Install dependencies
RUN yarn install

# Copy with owner 'appuser' (same from base image)
COPY --chown=appuser:appuser . /var/www/web/

# "yarn build" generates /var/www/web/dist, that is served by Nginx (from base image)
RUN yarn build

